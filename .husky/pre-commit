#!/bin/sh

# ===========================
# Pre-commit Hook
# ===========================
# 커밋 전 실행되는 검사 스크립트

echo "Running pre-commit checks..."

# 1. 린트 검사 (staged files only)
# npm run lint-staged 2>/dev/null || {
#     echo "Lint check failed. Please fix the errors and try again."
#     exit 1
# }

# 2. 타입 체크 (TypeScript 프로젝트)
# npm run type-check 2>/dev/null || {
#     echo "Type check failed. Please fix the errors and try again."
#     exit 1
# }

# 3. 테스트 실행 (선택적)
# npm test 2>/dev/null || {
#     echo "Tests failed. Please fix the errors and try again."
#     exit 1
# }

# 4. 시크릿 스캔
# 민감한 정보가 커밋되지 않도록 검사
# Uncomment to enable secret scanning
# check_secrets() {
#     staged_files=$(git diff --cached --name-only --diff-filter=ACM)
#     if [ -z "$staged_files" ]; then
#         return 0
#     fi
#     for pattern in \
#         "password\s*=\s*['\"][^'\"]+['\"]" \
#         "api[_-]\?key\s*=\s*['\"][^'\"]+['\"]" \
#         "secret\s*=\s*['\"][^'\"]+['\"]" \
#         "AWS_ACCESS_KEY_ID" \
#         "AWS_SECRET_ACCESS_KEY" \
#         "PRIVATE_KEY"; do
#         if echo "$staged_files" | xargs grep -l -E -i "$pattern" 2>/dev/null | grep -v ".example" | grep -v ".template"; then
#             echo "Warning: Possible secret found in staged files."
#             echo "Pattern: $pattern"
#             # exit 1  # Uncomment to block commit
#         fi
#     done
# }
# check_secrets

# 5. 파일 크기 검사
check_file_size() {
    max_size=5000000  # 5MB
    staged_files=$(git diff --cached --name-only --diff-filter=ACM)

    for file in $staged_files; do
        if [ -f "$file" ]; then
            size=$(wc -c < "$file")
            if [ "$size" -gt "$max_size" ]; then
                echo "Error: File $file is larger than 5MB. Consider using Git LFS."
                exit 1
            fi
        fi
    done
}

check_file_size

echo "Pre-commit checks passed!"
exit 0
