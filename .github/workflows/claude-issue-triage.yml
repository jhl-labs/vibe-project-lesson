# ===========================
# Claude Issue Triage
# ===========================
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” ìƒˆ ì´ìŠˆë¥¼ ìë™ìœ¼ë¡œ ë¶„ë¥˜í•˜ê³  ë¼ë²¨ë§í•©ë‹ˆë‹¤.
# ì£¼ì˜: API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤. Secretsì— ANTHROPIC_API_KEYë¥¼ ì„¤ì •í•˜ì„¸ìš”.

name: Claude Issue Triage

on:
  issues:
    types: [opened, edited]

permissions:
  issues: write
  contents: read

jobs:
  triage:
    name: Triage Issue
    runs-on: ubuntu-latest
    # ë´‡ì´ ë§Œë“  ì´ìŠˆëŠ” ì œì™¸
    if: github.event.issue.user.type != 'Bot'
    steps:
      - uses: actions/checkout@v4

      - name: Analyze issue with Claude
        id: analyze
        if: env.ANTHROPIC_API_KEY != ''
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # ì´ìŠˆ ì •ë³´ëŠ” í™˜ê²½ ë³€ìˆ˜ë¡œ ì•ˆì „í•˜ê²Œ ì „ë‹¬ë¨ (shell injection ë°©ì§€)
          # Claude APIë¥¼ í˜¸ì¶œí•˜ì—¬ ì´ìŠˆ ë¶„ì„
          # ì‹¤ì œ êµ¬í˜„ ì‹œ curl ë˜ëŠ” ì „ìš© action ì‚¬ìš©

          PROMPT="Analyze this GitHub issue and provide:
          1. Category: bug, feature, documentation, question, or other
          2. Priority: critical, high, medium, low
          3. Components: affected areas (comma-separated)
          4. Summary: one-line summary in Korean

          Issue Title: ${ISSUE_TITLE}

          Issue Body:
          ${ISSUE_BODY}

          Respond in JSON format:
          {
            \"category\": \"...\",
            \"priority\": \"...\",
            \"components\": [\"...\"],
            \"summary\": \"...\"
          }"

          # ì—¬ê¸°ì— ì‹¤ì œ Claude API í˜¸ì¶œ ë¡œì§ ì¶”ê°€
          echo "Analysis would be performed here"

          # ê¸°ë³¸ê°’ ì„¤ì • (ì‹¤ì œ êµ¬í˜„ ì‹œ Claude ì‘ë‹µìœ¼ë¡œ ëŒ€ì²´)
          echo "category=triage" >> $GITHUB_OUTPUT
          echo "priority=medium" >> $GITHUB_OUTPUT

      - name: Apply labels
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number;

            // ê¸°ì¡´ ë¼ë²¨ ê°€ì ¸ì˜¤ê¸°
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            const existingLabels = issue.labels.map(l => l.name);

            // triage ë¼ë²¨ì´ ì—†ìœ¼ë©´ ì¶”ê°€
            if (!existingLabels.includes('triage')) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['triage']
              });
            }

            // ì´ìŠˆ ì œëª© ê¸°ë°˜ ê°„ë‹¨í•œ ë¶„ë¥˜
            const title = context.payload.issue.title.toLowerCase();

            const labelsToAdd = [];

            if (title.includes('bug') || title.includes('error') || title.includes('fix')) {
              labelsToAdd.push('bug');
            }
            if (title.includes('feature') || title.includes('enhancement') || title.includes('add')) {
              labelsToAdd.push('enhancement');
            }
            if (title.includes('doc') || title.includes('readme')) {
              labelsToAdd.push('documentation');
            }
            if (title.includes('security') || title.includes('vulnerability')) {
              labelsToAdd.push('security');
            }
            if (title.includes('question') || title.includes('help') || title.includes('how')) {
              labelsToAdd.push('question');
            }

            if (labelsToAdd.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: labelsToAdd
              });
            }

      - name: Add initial comment
        if: env.ANTHROPIC_API_KEY == ''
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number;

            // ì¤‘ë³µ ì½”ë©˜íŠ¸ ë°©ì§€
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            const hasTriageComment = comments.some(c =>
              c.user.type === 'Bot' && c.body.includes('ì´ìŠˆê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤')
            );

            if (!hasTriageComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `## ì´ìŠˆê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ“‹

ì´ìŠˆë¥¼ ì œì¶œí•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤!

- ì´ìŠˆëŠ” ê³§ ê²€í† ë  ì˜ˆì •ì…ë‹ˆë‹¤
- ì¶”ê°€ ì •ë³´ê°€ í•„ìš”í•˜ë©´ ìš”ì²­ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤
- ê¸´ê¸‰í•œ ë³´ì•ˆ ì´ìŠˆëŠ” [SECURITY.md](../SECURITY.md)ë¥¼ ì°¸ì¡°í•´ ì£¼ì„¸ìš”

---
*ì´ ë©”ì‹œì§€ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*`
              });
            }
