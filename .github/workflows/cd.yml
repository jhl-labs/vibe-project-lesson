# ===========================
# CD Pipeline
# ===========================
# 이 워크플로우는 main 브랜치 푸시 또는 릴리스 생성 시 배포를 수행합니다.
# 프로젝트에 맞게 배포 단계를 커스터마이즈하세요.

name: CD

on:
  push:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "*.md"
      - ".github/ISSUE_TEMPLATE/**"
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  # 프로젝트별 환경 변수
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ===========================
  # 빌드 & 푸시
  # ===========================
  build:
    name: Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="sha-$(git rev-parse --short HEAD)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      # Docker 빌드 예시
      # - name: Set up Docker Buildx
      #   uses: docker/setup-buildx-action@v3
      #
      # - name: Log in to Container Registry
      #   uses: docker/login-action@v3
      #   with:
      #     registry: ${{ env.REGISTRY }}
      #     username: ${{ github.actor }}
      #     password: ${{ secrets.GITHUB_TOKEN }}
      #
      # - name: Extract metadata
      #   id: meta
      #   uses: docker/metadata-action@v5
      #   with:
      #     images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
      #     tags: |
      #       type=ref,event=branch
      #       type=semver,pattern={{version}}
      #       type=sha,prefix=sha-
      #
      # - name: Build and push
      #   uses: docker/build-push-action@v5
      #   with:
      #     context: .
      #     push: true
      #     tags: ${{ steps.meta.outputs.tags }}
      #     labels: ${{ steps.meta.outputs.labels }}
      #     cache-from: type=gha
      #     cache-to: type=gha,mode=max

      - name: Placeholder
        run: echo "Configure build steps for your project"

  # ===========================
  # Staging 배포
  # ===========================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://staging.example.com
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Staging
        run: |
          echo "Deploying version ${{ needs.build.outputs.version }} to staging"
          # 배포 명령어 추가
          # kubectl apply -f k8s/staging/
          # terraform apply -auto-approve
          # aws ecs update-service ...

      # Slack 알림 예시
      # - name: Notify Slack
      #   uses: slackapi/slack-github-action@v1
      #   with:
      #     payload: |
      #       {
      #         "text": "Deployed ${{ needs.build.outputs.version }} to staging"
      #       }
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ===========================
  # Production 배포
  # ===========================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, deploy-staging]
    if: |
      always() &&
      needs.build.result == 'success' &&
      (needs.deploy-staging.result == 'success' || needs.deploy-staging.result == 'skipped') &&
      (github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'))
    environment:
      name: production
      url: https://example.com
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Production
        run: |
          echo "Deploying version ${{ needs.build.outputs.version }} to production"
          # 배포 명령어 추가

      # - name: Create deployment record
      #   run: |
      #     gh api repos/${{ github.repository }}/deployments \
      #       -f ref=${{ github.sha }} \
      #       -f environment=production \
      #       -f description="Production deployment"

  # ===========================
  # 롤백 (수동)
  # ===========================
  # rollback:
  #   name: Rollback
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'workflow_dispatch'
  #   environment:
  #     name: ${{ github.event.inputs.environment }}
  #   steps:
  #     - name: Rollback deployment
  #       run: echo "Implement rollback logic"
