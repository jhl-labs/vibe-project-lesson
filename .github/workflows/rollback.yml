# ===========================
# Rollback Workflow
# ===========================
# ê¸´ê¸‰ ë¡¤ë°±ì„ ìœ„í•œ ì›Œí¬í”Œë¡œìš°ì…ë‹ˆë‹¤.
# í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ ë¬¸ì œ ë°œìƒ ì‹œ ì´ì „ ë²„ì „ìœ¼ë¡œ ë¹ ë¥´ê²Œ ë³µêµ¬í•©ë‹ˆë‹¤.

name: Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "ë¡¤ë°±í•  í™˜ê²½"
        required: true
        type: choice
        options:
          - staging
          - production
      target-version:
        description: "ë¡¤ë°±í•  ë²„ì „ (íƒœê·¸ ë˜ëŠ” ì»¤ë°‹ SHA)"
        required: true
        type: string
      reason:
        description: "ë¡¤ë°± ì‚¬ìœ "
        required: true
        type: string
      skip-approval:
        description: "ìŠ¹ì¸ ì ˆì°¨ ê±´ë„ˆë›°ê¸° (ê¸´ê¸‰ ìƒí™©ë§Œ)"
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  deployments: write
  issues: write

concurrency:
  group: rollback-${{ github.event.inputs.environment }}
  cancel-in-progress: false

jobs:
  # ===========================
  # ê²€ì¦
  # ===========================
  validate:
    name: Validate Rollback
    runs-on: ubuntu-latest
    outputs:
      valid: ${{ steps.check.outputs.valid }}
      commit: ${{ steps.check.outputs.commit }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate target version
        id: check
        run: |
          TARGET="${{ github.event.inputs.target-version }}"

          # íƒœê·¸ì¸ì§€ í™•ì¸
          if git rev-parse "refs/tags/$TARGET" >/dev/null 2>&1; then
            COMMIT=$(git rev-parse "refs/tags/$TARGET")
            echo "Target is a tag: $TARGET -> $COMMIT"
          elif git rev-parse "$TARGET" >/dev/null 2>&1; then
            COMMIT=$(git rev-parse "$TARGET")
            echo "Target is a commit: $COMMIT"
          else
            echo "Error: Invalid target version '$TARGET'"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "valid=true" >> $GITHUB_OUTPUT
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT

      - name: Check deployment history
        run: |
          echo "## Deployment History" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | Date | Commit |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|------|--------|" >> $GITHUB_STEP_SUMMARY

          # ìµœê·¼ 10ê°œ íƒœê·¸ í‘œì‹œ
          git tag --sort=-creatordate | head -10 | while read tag; do
            DATE=$(git log -1 --format=%ci "$tag" 2>/dev/null | cut -d' ' -f1)
            COMMIT=$(git rev-parse --short "$tag" 2>/dev/null)
            echo "| $tag | $DATE | $COMMIT |" >> $GITHUB_STEP_SUMMARY
          done

  # ===========================
  # ìŠ¹ì¸ (Productionë§Œ)
  # ===========================
  approval:
    name: Approval
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.valid == 'true' && github.event.inputs.environment == 'production' && github.event.inputs.skip-approval != 'true'
    environment:
      name: production-rollback-approval
    steps:
      - name: Approval received
        run: |
          echo "Rollback approved by: ${{ github.actor }}"
          echo "Target: ${{ github.event.inputs.target-version }}"
          echo "Reason: ${{ github.event.inputs.reason }}"

  # ===========================
  # ë¡¤ë°± ì‹¤í–‰
  # ===========================
  rollback:
    name: Execute Rollback
    runs-on: ubuntu-latest
    needs: [validate, approval]
    # approvalì´ skipë˜ì—ˆê±°ë‚˜ ì„±ê³µí•œ ê²½ìš°, ë˜ëŠ” stagingì¸ ê²½ìš° ì‹¤í–‰
    if: |
      always() &&
      needs.validate.outputs.valid == 'true' &&
      (needs.approval.result == 'success' || needs.approval.result == 'skipped')
    environment:
      name: ${{ github.event.inputs.environment }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate.outputs.commit }}

      - name: Pre-rollback checks
        run: |
          echo "## Pre-Rollback Checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- Target Version: ${{ github.event.inputs.target-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Target Commit: ${{ needs.validate.outputs.commit }}" >> $GITHUB_STEP_SUMMARY
          echo "- Initiated by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- Reason: ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY

      - name: Execute rollback
        id: rollback
        run: |
          echo "Executing rollback..."

          # ì‹¤ì œ ë¡¤ë°± ë¡œì§ì€ í”„ë¡œì íŠ¸ì— ë§ê²Œ êµ¬í˜„
          # ì˜ˆì‹œ:
          # - Kubernetes: kubectl rollout undo
          # - AWS ECS: aws ecs update-service
          # - Docker: docker-compose up -d
          # - Vercel: vercel rollback

          # í”Œë ˆì´ìŠ¤í™€ë”
          echo "Rollback commands would be executed here"

          # kubectl rollout undo deployment/app -n ${{ github.event.inputs.environment }}
          # ë˜ëŠ”
          # aws ecs update-service --cluster prod --service app --task-definition app:$PREVIOUS_VERSION

          echo "status=success" >> $GITHUB_OUTPUT

      - name: Verify rollback
        run: |
          echo "Verifying rollback..."

          # í—¬ìŠ¤ ì²´í¬
          # curl -f https://api.example.com/health

          # ë²„ì „ í™•ì¸
          # curl https://api.example.com/version

          echo "Verification commands would be executed here"

      - name: Notify success
        if: steps.rollback.outputs.status == 'success'
        run: |
          echo "## âœ… Rollback Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Rollback to ${{ github.event.inputs.target-version }} completed successfully." >> $GITHUB_STEP_SUMMARY

  # ===========================
  # ì‚¬í›„ ì²˜ë¦¬
  # ===========================
  post-rollback:
    name: Post Rollback
    runs-on: ubuntu-latest
    needs: rollback
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Create incident issue
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ needs.rollback.result }}' === 'success' ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Rollback] ${{ github.event.inputs.environment }} - ${{ github.event.inputs.target-version }}`,
              body: `## ë¡¤ë°± ê¸°ë¡

            | í•­ëª© | ê°’ |
            |------|-----|
            | í™˜ê²½ | ${{ github.event.inputs.environment }} |
            | ëŒ€ìƒ ë²„ì „ | ${{ github.event.inputs.target-version }} |
            | ì‹¤í–‰ì | @${{ github.actor }} |
            | ìƒíƒœ | ${status} |
            | ì‹œê° | ${new Date().toISOString()} |

            ### ì‚¬ìœ 

            ${{ github.event.inputs.reason }}

            ### í›„ì† ì¡°ì¹˜

            - [ ] ê·¼ë³¸ ì›ì¸ ë¶„ì„ (RCA) ì‘ì„±
            - [ ] ì¬ë°œ ë°©ì§€ ëŒ€ì±… ìˆ˜ë¦½
            - [ ] ê´€ë ¨ íŒ€ ê³µìœ 

            ---
            *ì´ ì´ìŠˆëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*`,
              labels: ['incident', 'rollback', '${{ github.event.inputs.environment }}']
            });

      # Slack ì•Œë¦¼ ì˜ˆì‹œ
      # - name: Notify Slack
      #   uses: slackapi/slack-github-action@v1
      #   with:
      #     payload: |
      #       {
      #         "text": "ğŸ”„ Rollback executed on ${{ github.event.inputs.environment }}",
      #         "blocks": [
      #           {
      #             "type": "section",
      #             "text": {
      #               "type": "mrkdwn",
      #               "text": "*Rollback to ${{ github.event.inputs.target-version }}*\nEnvironment: ${{ github.event.inputs.environment }}\nReason: ${{ github.event.inputs.reason }}"
      #             }
      #           }
      #         ]
      #       }
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
