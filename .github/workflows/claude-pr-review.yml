# ===========================
# Claude PR Review
# ===========================
# 이 워크플로우는 Claude AI를 사용하여 PR을 자동으로 리뷰합니다.
# 주의: API 키가 필요합니다. Secrets에 ANTHROPIC_API_KEY를 설정하세요.

name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    name: AI Code Review
    runs-on: ubuntu-latest
    # Draft PR은 제외
    if: github.event.pull_request.draft == false
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed
        run: |
          # PR의 변경된 파일 목록 가져오기
          FILES=$(gh pr diff ${{ github.event.pull_request.number }} --name-only)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get diff
        id: diff
        run: |
          DIFF=$(gh pr diff ${{ github.event.pull_request.number }})
          # GitHub Actions 출력 크기 제한으로 인해 잘라낼 수 있음
          DIFF_TRUNCATED=$(echo "$DIFF" | head -c 50000)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF_TRUNCATED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Claude API 직접 호출 방식
      # Anthropic의 공식 GitHub Action이 나오면 교체 권장
      - name: Review with Claude
        id: review
        if: env.ANTHROPIC_API_KEY != ''
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          CHANGED_FILES: ${{ steps.changed.outputs.files }}
          PR_DIFF: ${{ steps.diff.outputs.diff }}
        run: |
          # PR 정보는 환경 변수로 안전하게 전달됨 (shell injection 방지)

          # Claude API 호출을 위한 프롬프트
          PROMPT="You are a code reviewer. Review this PR and provide constructive feedback.

          PR Title: ${PR_TITLE}

          PR Description:
          ${PR_BODY}

          Changed Files:
          ${CHANGED_FILES}

          Diff:
          ${PR_DIFF}

          Please review and provide:
          1. Summary of changes
          2. Potential issues or bugs
          3. Code quality suggestions
          4. Security concerns (if any)
          5. Overall assessment

          Keep the review concise and actionable. Use Korean for the review."

          # 여기에 실제 Claude API 호출 로직 추가
          # 예: curl 또는 전용 action 사용
          echo "Claude review would be performed here with the API"

      # 대안: PR Agent 또는 다른 AI 리뷰 도구 사용
      # - name: AI Review with PR Agent
      #   uses: Codium-ai/pr-agent@main
      #   env:
      #     OPENAI_KEY: ${{ secrets.OPENAI_API_KEY }}
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   with:
      #     command: review

      - name: Post placeholder comment
        if: env.ANTHROPIC_API_KEY == ''
        uses: actions/github-script@v7
        with:
          script: |
            // API 키가 설정되지 않은 경우 안내 메시지
            const body = `## AI Code Review

            > **Note**: Claude PR Review가 설정되지 않았습니다.

            이 기능을 활성화하려면:
            1. Repository Settings > Secrets에서 \`ANTHROPIC_API_KEY\`를 설정하세요
            2. [Anthropic Console](https://console.anthropic.com/)에서 API 키를 생성할 수 있습니다

            ---
            *이 메시지는 자동으로 생성되었습니다.*`;

            // 기존 코멘트가 있는지 확인
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.data.find(c =>
              c.user.type === 'Bot' && c.body.includes('AI Code Review')
            );

            if (!botComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
