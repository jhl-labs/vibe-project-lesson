import { Meta } from '@storybook/blocks';
import { Callout } from '../../components/Callout';
import { CodeBlock } from '../../components/CodeBlock';
import { TemplateFileViewer } from '../../components/TemplateFileViewer';
import { ComparisonTable } from '../../components/ComparisonTable';
import { Quiz } from '../../components/Quiz';
import { ChapterNav } from '../../components/ChapterNav';
import { templateFiles } from '../../data/template-files';

<Meta title="Part 2: 프로젝트 템플릿 구조/아키텍처" />

# 아키텍처

> Clean Architecture 기반 4레이어 설계

## 아키텍처 원칙

이 프로젝트 템플릿은 **Clean Architecture**를 기반으로 4가지 핵심 원칙을 따릅니다:

| 원칙 | 설명 |
|------|------|
| **관심사의 분리** | 각 레이어/모듈은 명확한 책임을 가짐 |
| **의존성 역전** | 고수준 모듈이 저수준 모듈에 의존하지 않음 |
| **단일 진실 공급원** | 각 데이터는 하나의 위치에서만 관리 |
| **실패를 위한 설계** | 모든 외부 호출은 실패할 수 있음을 가정 |

## 4레이어 구조

<CodeBlock
  code={`┌─────────────────────────────────────────────────────────────┐
│                     Presentation Layer                       │
│   REST API  │   GraphQL API  │   gRPC Service               │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    Application Layer                         │
│            Use Cases / Application Services                  │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                      Domain Layer                            │
│     Entities  │  Value Objects  │  Domain Services           │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                  Infrastructure Layer                        │
│   Repository  │  External APIs  │  Message Queue  │  Cache  │
└─────────────────────────────────────────────────────────────┘`}
  language="text"
  filename="Clean Architecture 4레이어"
/>

<Callout type="important" title="의존성 방향">
  의존성은 항상 안쪽(Domain)을 향합니다:
  Presentation → Application → Domain ← Infrastructure
</Callout>

## 레이어별 책임

<ComparisonTable
  title="레이어별 역할 비교"
  headers={['항목', 'Presentation', 'Application', 'Domain', 'Infrastructure']}
  rows={[
    { feature: 'HTTP 처리', values: ['yes', 'no', 'no', 'no'] },
    { feature: '비즈니스 로직', values: ['no', 'no', 'yes', 'no'] },
    { feature: '유스케이스 조합', values: ['no', 'yes', 'no', 'no'] },
    { feature: 'DB 접근', values: ['no', 'no', 'no', 'yes'] },
    { feature: '입력 검증', values: ['yes', 'no', 'no', 'no'] },
    { feature: '트랜잭션 관리', values: ['no', 'yes', 'no', 'no'] },
    { feature: '외부 API 호출', values: ['no', 'no', 'no', 'yes'] },
    { feature: '도메인 이벤트', values: ['no', 'partial', 'yes', 'no'] },
  ]}
/>

## 데이터 흐름

<CodeBlock
  code={`Client Request
     │
     ▼
┌─────────────────┐
│   Controller    │ ─── 입력 검증, 인증 확인, DTO 변환
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   Use Case      │ ─── 비즈니스 오케스트레이션, 트랜잭션 경계
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Domain Service  │ ─── 비즈니스 로직 실행, 규칙 강제
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   Repository    │ ─── 데이터 영속화, 외부 시스템 통합
└────────┬────────┘
         │
         ▼
    Database`}
  language="text"
  filename="요청 처리 흐름"
/>

## 실제 architecture.md 파일

<TemplateFileViewer
  filename=".agent/architecture.md"
  content={templateFiles['.agent/architecture.md']}
  language="markdown"
  annotations={[
    { lineStart: 1, lineEnd: 24, text: '아키텍처 원칙 섹션입니다. 4가지 핵심 원칙(관심사 분리, 의존성 역전, 단일 진실 공급원, 실패를 위한 설계)을 정의합니다.' },
    { lineStart: 26, lineEnd: 67, text: '레이어 아키텍처 다이어그램입니다. ASCII 아트로 Presentation, Application, Domain, Infrastructure 4개 레이어를 시각적으로 표현합니다.' },
    { lineStart: 69, lineEnd: 97, text: 'Presentation Layer 상세입니다. HTTP 처리, 입력 검증, 인증/인가, DTO 변환의 책임과 코드 예제를 포함합니다.' },
    { lineStart: 99, lineEnd: 130, text: 'Application Layer 상세입니다. 유스케이스 오케스트레이션, 트랜잭션 관리, 이벤트 발행의 역할을 보여줍니다.' },
    { lineStart: 132, lineEnd: 176, text: 'Domain Layer 상세입니다. 엔터티, 값 객체, 도메인 서비스의 구현 예제를 보여줍니다. 비즈니스 로직의 핵심입니다.' },
    { lineStart: 178, lineEnd: 216, text: 'Infrastructure Layer 상세입니다. Repository 구현, 외부 API 클라이언트, DB 설정 등 기술적 구현체를 보여줍니다.' },
  ]}
/>

<Quiz
  title="아키텍처 이해도 확인"
  questions={[
    {
      question: 'Clean Architecture에서 의존성 방향은?',
      options: ['Domain → Infrastructure', 'Infrastructure → Domain', '외부에서 내부(Domain) 방향', '내부에서 외부 방향'],
      correctIndex: 2,
      explanation: 'Clean Architecture에서 의존성은 항상 외부에서 내부(Domain) 방향으로 향합니다. Domain 레이어는 다른 어떤 레이어에도 의존하지 않습니다.',
    },
    {
      question: '비즈니스 로직을 담당하는 레이어는?',
      options: ['Presentation Layer', 'Application Layer', 'Domain Layer', 'Infrastructure Layer'],
      correctIndex: 2,
      explanation: 'Domain Layer는 비즈니스 로직을 캡슐화하고, 비즈니스 규칙을 강제하며, 도메인 불변성을 유지하는 핵심 레이어입니다.',
    },
    {
      question: 'DB 접근을 담당하는 레이어는?',
      options: ['Presentation Layer', 'Application Layer', 'Domain Layer', 'Infrastructure Layer'],
      correctIndex: 3,
      explanation: 'Infrastructure Layer가 Repository 구현, 외부 API 클라이언트, DB 설정 등 기술적 구현을 담당합니다.',
    },
  ]}
/>

<ChapterNav
  prev={{ title: '컨텍스트와 컨벤션', path: '/docs/part-2--프로젝트-템플릿-구조-컨텍스트와-컨벤션' }}
  next={{ title: '가이드라인', path: '/docs/part-2--프로젝트-템플릿-구조-가이드라인' }}
/>
