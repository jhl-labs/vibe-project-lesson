import { Meta } from '@storybook/addon-docs/blocks';
import { Callout } from '../../components/Callout';
import { CodeBlock } from '../../components/CodeBlock';
import { ComparisonTable } from '../../components/ComparisonTable';
import { ChapterNav } from '../../components/ChapterNav';

<Meta title="Part 2: 프로젝트 템플릿 구조/가이드라인" />

# 가이드라인

> AI 에이전트 사용의 원칙과 규칙을 `.claude/rules/`에 정의하는 방법

## 핵심 원칙

### 책임 소재

<Callout type="important" title="가장 중요한 원칙">
  AI 생성 코드의 최종 책임은 커밋한 개발자에게 있습니다.
  "AI가 만들어준 코드"는 면책 사유가 되지 않습니다.
</Callout>

### 검증 절차

<CodeBlock
  code={`AI 코드 생성 → 개발자 검토 → 단위 테스트 → 보안 스캔 → 코드 리뷰 → 머지`}
  language="text"
  filename="AI 코드 검증 파이프라인"
/>

## 가이드라인을 .claude/rules/에 문서화하기

허용/금지 사항을 `.claude/rules/guidelines.md`에 정의하면, Claude Code가 코드 생성 시 자동으로 이 규칙을 참조합니다:

<CodeBlock
  code={`# AI 사용 가이드라인

## 허용 사항 (권장)
- 보일러플레이트 코드 생성 → 구조 확인 후 사용
- 테스트 케이스 초안 작성 → 커버리지 검토 필수
- 문서화 보조 → 내용 정확성 검증
- 코드 리뷰 1차 검토 → 보안 중점 확인
- 리팩토링 제안 → 영향도 분석 후 적용

## 금지 사항 (절대 금지)
- 보안 관련 코드 무검증 적용 → 보안 리뷰 필수
- 프로덕션 데이터를 프롬프트에 포함 → 익명화 데이터 사용
- 시크릿/API 키 노출 → 환경 변수로 관리
- 라이선스 불명확한 코드 복사 → 라이선스 확인 필수
- 개인정보(PII) 포함 프롬프트 → PII 제거 후 사용`}
  language="markdown"
  filename=".claude/rules/guidelines.md"
/>

<ComparisonTable
  title="AI 사용 가이드"
  headers={['사용 사례', '허용 여부', '주의사항']}
  rows={[
    { feature: '보일러플레이트 생성', values: ['yes', '구조 확인'] },
    { feature: '테스트 케이스 초안', values: ['yes', '커버리지 검토'] },
    { feature: '문서화 보조', values: ['yes', '내용 검증'] },
    { feature: '코드 리뷰 1차 검토', values: ['yes', '보안 중점'] },
    { feature: '리팩토링 제안', values: ['yes', '영향도 분석'] },
    { feature: '보안 코드 무검증 적용', values: ['no', '보안팀 검토 필수'] },
    { feature: '프로덕션 데이터 프롬프트', values: ['no', '익명화 데이터 사용'] },
    { feature: '시크릿 노출', values: ['no', '환경 변수만'] },
    { feature: '라이선스 불명 코드 복사', values: ['no', '라이선스 확인'] },
    { feature: '개인정보 포함 프롬프트', values: ['no', 'PII 제거'] },
  ]}
/>

---

## Claude Code 권한 모델

Claude Code는 `.claude/settings.json`에서 도구별 권한을 세밀하게 제어합니다.
권한은 `allow` (자동 허용), `deny` (차단), 미지정 (매번 확인) 세 단계로 나뉩니다.

<CodeBlock
  code={`{
  "permissions": {
    "allow": [
      "Bash(npm test)",
      "Bash(npm run lint)",
      "Bash(npm run build)",
      "Read",
      "Glob",
      "Grep"
    ],
    "deny": [
      "Bash(curl*)",
      "Bash(wget*)",
      "Bash(rm -rf /)*"
    ]
  }
}`}
  language="json"
  filename=".claude/settings.json — 권한 설정"
/>

### 권한 규칙 문법

| 패턴 | 의미 | 예시 |
|------|------|------|
| `"ToolName"` | 도구 전체 허용/차단 | `"Read"` — 모든 파일 읽기 허용 |
| `"Bash(pattern)"` | 특정 명령 패턴만 | `"Bash(npm test)"` — npm test만 허용 |
| `"Bash(npm *)"` | 와일드카드 | `"Bash(npm *)"` — npm 명령 전체 허용 |
| `"Edit(src/**)"` | 경로 패턴 | `"Edit(src/**)"` — src/ 내 파일 편집만 허용 |

<Callout type="warning" title="권한 평가 순서">
  `deny`가 `allow`보다 우선합니다. 같은 패턴이 양쪽에 있으면 차단됩니다.
  예: allow에 `"Bash(rm *)"`, deny에 `"Bash(rm -rf *)"` → `rm -rf`는 차단, 다른 `rm`은 허용.
</Callout>

### settings.json vs settings.local.json

<ComparisonTable
  title="설정 파일 비교"
  headers={['구분', 'settings.json', 'settings.local.json']}
  rows={[
    { feature: '위치', values: ['.claude/settings.json', '.claude/settings.local.json'] },
    { feature: 'Git 추적', values: ['yes', 'no'] },
    { feature: '용도', values: ['팀 공통 권한 정책', '개인 권한 오버라이드'] },
    { feature: '적용 범위', values: ['팀 전체', '개인만'] },
  ]}
/>

---

## Hooks로 자동 검증 파이프라인 구축

Claude Code의 **Hooks**는 도구 실행 전후에 셸 스크립트를 자동 실행하는 기능입니다.
가이드라인 준수를 코드 수준에서 강제할 수 있습니다.

### Hook 이벤트 유형

| 이벤트 | 실행 시점 | 활용 예시 |
|--------|----------|----------|
| `PreToolUse` | 도구 실행 전 | 위험한 명령 차단, 파일 접근 제한 |
| `PostToolUse` | 도구 실행 후 | 린트 자동 실행, 포맷팅 적용 |
| `Notification` | 알림 발생 시 | 슬랙/디스코드 알림 전송 |
| `Stop` | 에이전트 턴 종료 시 | 자동 테스트 실행, 빌드 검증 |

### Hook 설정 예시

<CodeBlock
  code={`{
  "hooks": {
    "PostToolUse": [
      {
        "matcher": "Write|Edit",
        "hooks": [
          {
            "type": "command",
            "command": "npx eslint --fix $CLAUDE_FILE_PATH"
          }
        ]
      }
    ],
    "Stop": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "npm test -- --bail 2>/dev/null"
          }
        ]
      }
    ]
  }
}`}
  language="json"
  filename=".claude/settings.json — Hooks 설정"
/>

<Callout type="tip" title="Hook 종료 코드">
  Hook 스크립트가 **종료 코드 2**를 반환하면 해당 도구 실행이 차단됩니다.
  이를 활용하면 특정 조건에서 Claude의 동작을 프로그래밍적으로 제어할 수 있습니다.
</Callout>

### PreToolUse로 위험 동작 차단

<CodeBlock
  code={`{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Bash",
        "hooks": [
          {
            "type": "command",
            "command": "echo $CLAUDE_TOOL_INPUT | jq -r '.command' | grep -qE '(rm -rf /|DROP TABLE|shutdown)' && exit 2 || exit 0"
          }
        ]
      }
    ]
  }
}`}
  language="json"
  filename="위험 명령 차단 Hook"
/>

---

## 프롬프트 작성 가이드

### 좋은 프롬프트 vs 나쁜 프롬프트

<CodeBlock
  code={`## 좋은 프롬프트 예시

다음 조건을 만족하는 사용자 인증 서비스를 구현해주세요:

### 요구사항
- JWT 기반 인증
- 리프레시 토큰 지원
- bcrypt로 비밀번호 해싱 (cost factor: 12)

### 기술 스택
- TypeScript, Express.js, PostgreSQL

### 제약사항
- 기존 User 엔터티 사용
- 에러 처리는 AppError 클래스 사용
- 테스트 코드 포함

### 참고
- 기존 코드: src/services/base-service.ts
- 컨벤션: .claude/rules/conventions.md 참조`}
  language="markdown"
  filename="좋은 프롬프트"
/>

<CodeBlock
  code={`## 나쁜 프롬프트 예시

- "로그인 기능 만들어줘"
   → 너무 모호함, 요구사항 불명확

- "이 에러 고쳐줘: [프로덕션 로그 전체 복사]"
   → 민감한 데이터 포함 가능

- "AWS_SECRET_KEY=xxx 이거 사용해서 S3 연동해줘"
   → 시크릿 노출`}
  language="markdown"
  filename="나쁜 프롬프트"
/>

<Callout type="info" title="프롬프트에 컨텍스트를 제공하세요">
  Claude Code는 CLAUDE.md와 .claude/rules/를 자동으로 읽지만, 특정 작업에 필요한 추가 컨텍스트는 프롬프트에서 직접 알려주는 것이 효과적입니다.
  "src/services/auth.ts 파일을 참고해서"처럼 구체적인 파일 경로를 제시하면 Claude Code가 해당 파일을 읽고 기존 패턴을 따릅니다.
</Callout>

---

## AI 생성 코드 검증 체크리스트

| 카테고리 | 확인 항목 |
|----------|----------|
| **기능** | 요구사항 정확 구현, 엣지 케이스 처리, 에러 핸들링 |
| **보안** | 입력 검증, SQL/XSS 인젝션 방지, 인증/인가, 민감 정보 미포함 |
| **품질** | 코딩 컨벤션 준수, 중복 코드 없음, 테스트 작성 |
| **이해도** | 코드 동작 이해, 구현 이유 설명 가능, 디버깅 가능 |

<Callout type="tip" title="가이드라인 = 규칙 + 도구 설정의 조합">
  효과적인 가이드라인 체계는 세 가지 계층으로 구성됩니다:
  1. **문서화된 규칙** — `.claude/rules/guidelines.md`에 원칙과 허용/금지 사항 명시
  2. **권한 설정** — `.claude/settings.json`의 `permissions`로 도구 수준 제어
  3. **자동 검증** — Hooks로 린트, 테스트, 보안 스캔을 자동 실행

  이 세 계층이 함께 작동하면, AI가 생성하는 코드의 품질과 안전성을 체계적으로 보장할 수 있습니다.
</Callout>


<ChapterNav
  prev={{ title: '아키텍처', path: '/docs/part-2--프로젝트-템플릿-구조-아키텍처' }}
  next={{ title: '문서 템플릿', path: '/docs/part-2--프로젝트-템플릿-구조-문서-템플릿' }}
/>
