import { Meta } from '@storybook/addon-docs/blocks';
import { Callout } from '../../components/Callout';
import { CodeBlock } from '../../components/CodeBlock';
import { ComparisonTable } from '../../components/ComparisonTable';
import { MermaidDiagram } from '../../components/MermaidDiagram';
import { ChapterNav } from '../../components/ChapterNav';

<Meta title="Part 3: AI Agent 워크플로우/서브에이전트" />

# 서브에이전트 (Subagents)

> 전문 분야별 AI 에이전트 시스템

## 개요

서브에이전트는 **전문 분야별 AI 에이전트**입니다. Claude Code는 내부적으로 Task 도구를 통해 서브에이전트를 생성하며, 각 서브에이전트는 독립된 컨텍스트에서 작업을 수행합니다. `.claude/agents/` 디렉토리에 YAML 프론트매터가 포함된 마크다운 파일로 역할별 정의를 저장하여 일관된 전문성을 유지합니다. `/agents` 커맨드로 관리하거나 직접 파일을 생성할 수 있습니다. Anthropic은 대화 초반에 서브에이전트를 적극 활용하여 컨텍스트를 보존하면서 세부 작업을 병렬 처리할 것을 권장합니다.

<Callout type="info" title="핵심 개념">
  서브에이전트는 "한 명의 전문가"와 같습니다.
  아키텍트, 보안 전문가, 테스터, 테크니컬 라이터 — 각각의 전문성을 가진 AI 에이전트가 협력합니다.
</Callout>

## Claude Code 빌트인 서브에이전트

Claude Code는 내부적으로 6개의 빌트인 서브에이전트를 제공합니다. 이들은 Task 도구를 통해 자동으로 선택·실행됩니다.

| 서브에이전트 | 역할 | 사용 가능 도구 |
|-------------|------|---------------|
| **Explore** | 코드베이스 탐색, 파일/키워드 검색 | Read, Glob, Grep 등 (편집 불가) |
| **Plan** | 구현 전략 설계, 아키텍처 분석 | Read, Glob, Grep 등 (편집 불가) |
| **general-purpose** | 복잡한 멀티스텝 작업 수행 | 모든 도구 |
| **Bash** | 셸 명령 실행 전문 | Bash |
| **statusline-setup** | 상태줄 설정 | Read, Edit |
| **Claude Code Guide** | Claude Code 사용법 안내 | Read, Glob, Grep, WebFetch, WebSearch |

<Callout type="tip" title="빌트인 vs 커스텀">
  빌트인 서브에이전트는 Claude Code가 상황에 맞게 자동 선택합니다.
  커스텀 서브에이전트는 `.claude/agents/` 디렉토리에 정의하여 프로젝트 특화 전문성을 추가합니다.
</Callout>

---

## 커스텀 서브에이전트 — 이 프로젝트 템플릿 정의 (4개)

이 프로젝트 템플릿에서 정의한 4개의 커스텀 서브에이전트입니다. `.claude/agents/` 디렉토리에 마크다운 파일로 작성합니다.

<ComparisonTable
  title="커스텀 서브에이전트 비교"
  headers={['항목', 'Architect', 'Security', 'Test', 'Documentation']}
  rows={[
    { feature: '전문 분야', values: ['시스템 설계', '보안 분석', '테스트 전략', '기술 문서'] },
    { feature: '주요 산출물', values: ['ADR, 설계안', '취약점 리포트', '테스트 코드', 'API 문서'] },
    { feature: '참조 지식', values: ['아키텍처 패턴', 'OWASP Top 10', '테스트 피라미드', '문서 표준'] },
    { feature: '활용 시점', values: ['설계/기술 결정', '보안 검토', '테스트 작성', '문서화'] },
  ]}
/>

### 에이전트 정의 파일 구조

<CodeBlock
  code={`---
name: agent-name           # 에이전트 식별자
description: 역할 설명      # Claude가 자동 매칭에 사용
tools: Read, Glob, Grep    # 사용 가능한 도구 목록
model: sonnet              # 사용할 모델 (sonnet, opus 등)
---

# 시스템 프롬프트
에이전트의 역할, 전문성, 작업 절차를 마크다운으로 정의합니다.
이 내용이 서브에이전트의 시스템 프롬프트로 사용됩니다.`}
  language="markdown"
  filename=".claude/agents/ 파일 구조"
/>

---

## Architect 서브에이전트

시스템 설계 및 기술 의사결정을 전문으로 합니다. 아키텍처 검토, ADR 작성, 기술 스택 평가를 수행합니다.

### 에이전트 정의

<CodeBlock
  code={`---
name: architect
description: Analyzes system architecture and makes technical decisions
tools: Read, Glob, Grep, Bash
model: sonnet
---

You are a senior software architect. Your responsibilities:
1. Analyze current system architecture and identify improvement areas
2. Evaluate technology choices with structured comparison matrices
3. Write Architecture Decision Records (ADRs)
4. Ensure architectural principles (SOLID, DDD, Clean Architecture) are followed

Always provide:
- Component dependency analysis
- SWOT analysis for architectural decisions
- Weighted comparison matrices for technology selections`}
  language="markdown"
  filename=".claude/agents/architect.md"
/>

### 분석 프레임워크

<CodeBlock
  code={`## 아키텍처 분석 출력 예시

### 컴포넌트 맵
- 현재 시스템 구성 분석
- 의존성 그래프 작성
- 병목 지점 식별

### SWOT 분석
- Strengths: 현재 아키텍처의 강점
- Weaknesses: 개선이 필요한 부분
- Opportunities: 활용 가능한 기술/패턴
- Threats: 잠재적 위험 요소

### 기술 선정 매트릭스
| 기준 | 가중치 | 옵션 A | 옵션 B |
|------|--------|--------|--------|
| 성능 | 30% | 8/10 | 7/10 |
| 확장성 | 25% | 9/10 | 6/10 |
| 학습 곡선 | 20% | 5/10 | 8/10 |
| 커뮤니티 | 15% | 7/10 | 9/10 |
| 비용 | 10% | 6/10 | 8/10 |

### 결정
가중 점수 기반 옵션 A 선택 (7.35 vs 7.15)`}
  language="markdown"
  filename="Architect 분석 출력 예시"
/>

---

## Security 서브에이전트

보안 코드 리뷰와 취약점 분석을 전문으로 합니다. OWASP Top 10 기반 분석, 공격 시나리오 시뮬레이션, 수정 코드 제안을 수행합니다.

### 에이전트 정의

<CodeBlock
  code={`---
name: security-reviewer
description: Reviews code for security vulnerabilities
tools: Read, Glob, Grep, Bash
model: sonnet
---

You are a security expert specializing in application security.
Analyze code for OWASP Top 10 vulnerabilities with focus on:
1. Injection attacks (SQL, NoSQL, OS command, LDAP)
2. Broken authentication and session management
3. Cross-Site Scripting (XSS)
4. Insecure Direct Object References (IDOR)
5. Security misconfigurations
6. Sensitive data exposure

For each vulnerability found, provide:
- Severity (Critical/High/Medium/Low)
- Exact file and line location
- Attack scenario demonstrating the risk
- Remediation code with explanation
- CWE/OWASP reference`}
  language="markdown"
  filename=".claude/agents/security-reviewer.md"
/>

### 취약점 리포트 출력 형식

<CodeBlock
  code={`## 보안 분석 리포트

### 취약점 #1: IDOR (Insecure Direct Object Reference)
- 심각도: 🔴 Critical
- 위치: src/api/users.ts:45
- 유형: OWASP A01:2025 — Broken Access Control

### 현재 코드 (취약)
@Get(':id')
async getUser(@Param('id') id: string) {
  return this.userService.findById(id); // 권한 확인 없음
}

### 공격 시나리오
curl -H "Authorization: Bearer <attacker_token>" \\
     https://api.example.com/users/victim-user-id

### 수정 코드
@Get(':id')
@UseGuards(AuthGuard)
async getUser(@Param('id') id: string, @CurrentUser() user: User) {
  if (id !== user.id && !user.isAdmin) {
    throw new ForbiddenException();
  }
  return this.userService.findById(id);
}

### 참고: CWE-639, OWASP A01:2025`}
  language="typescript"
  filename="Security 리포트 출력 예시"
/>

---

## Test 서브에이전트

테스트 전략 수립과 테스트 코드 생성을 전문으로 합니다. 단위/통합/E2E 테스트 코드, 커버리지 분석, 테스트 리뷰를 수행합니다.

### 에이전트 정의

<CodeBlock
  code={`---
name: test-strategist
description: Creates test strategies and generates test code
tools: Read, Glob, Grep, Bash
model: sonnet
---

You are a test engineering expert. Your responsibilities:
1. Analyze code and determine optimal test strategy
2. Follow the test pyramid: Unit (70%) > Integration (20%) > E2E (10%)
3. Apply FIRST principles (Fast, Independent, Repeatable, Self-validating, Timely)
4. Use AAA pattern (Arrange-Act-Assert) for all tests
5. Generate comprehensive test cases including edge cases

For each test file, provide:
- Test case list with descriptions
- Complete test code with mocks and fixtures
- Expected coverage metrics per layer
- Factory patterns for test data`}
  language="markdown"
  filename=".claude/agents/test.md"
/>

### 테스트 전략 출력 예시

<CodeBlock
  code={`## 테스트 전략: UserService

### 테스트 케이스 목록
| # | 유형 | 케이스 | 예상 결과 |
|---|------|--------|----------|
| 1 | Unit | 유효한 데이터로 사용자 생성 | 사용자 객체 반환 |
| 2 | Unit | 잘못된 이메일로 생성 시도 | ValidationError |
| 3 | Unit | 중복 이메일로 생성 시도 | DuplicateError |
| 4 | Unit | 존재하지 않는 사용자 조회 | null 반환 |
| 5 | Integration | POST /api/users 201 응답 | 생성된 사용자 JSON |
| 6 | Integration | POST /api/users 409 중복 | 에러 메시지 |

### 테스트 코드 (발췌)
describe('UserService', () => {
  const mockRepo: jest.Mocked<IUserRepository> = {
    findByEmail: jest.fn(),
    save: jest.fn(),
  };

  it('should create user with valid data', async () => {
    mockRepo.findByEmail.mockResolvedValue(null);
    mockRepo.save.mockResolvedValue({ id: '1', email: 'test@test.com' });

    const result = await service.createUser({ email: 'test@test.com' });
    expect(result.id).toBe('1');
    expect(mockRepo.save).toHaveBeenCalledTimes(1);
  });
});

### 커버리지 예상
- Lines: ~85%  |  Branches: ~80%  |  Functions: ~90%`}
  language="typescript"
  filename="Test 전략 출력 예시"
/>

---

## Documentation 서브에이전트

기술 문서 작성을 전문으로 합니다. API 문서(REST, GraphQL), 코드 문서(JSDoc, Docstring), README, 코드-문서 동기화 검증을 수행합니다.

### 에이전트 정의

<CodeBlock
  code={`---
name: documentation
description: Generates and maintains technical documentation
tools: Read, Glob, Grep, Bash
model: sonnet
---

You are a technical writer specializing in developer documentation.
Your responsibilities:
1. Generate API documentation (REST endpoints with Request/Response schemas)
2. Create code documentation (JSDoc for TypeScript, Docstrings for Python)
3. Structure README files with badges, quick start, and architecture overview
4. Write Architecture Decision Records (ADRs)
5. Verify code-documentation synchronization

Documentation quality standards:
- Accuracy: Must match current code behavior
- Completeness: All public APIs documented with examples
- Clarity: Written for developers unfamiliar with the codebase
- Searchability: Consistent headings and structure`}
  language="markdown"
  filename=".claude/agents/documentation.md"
/>

### 문서 생성 출력 예시

<CodeBlock
  code={`## 생성된 문서

### 파일: docs/api/users.md

## POST /api/v1/users — 사용자 생성

### Request
Content-Type: application/json
Authorization: Bearer <token>

{
  "email": "user@example.com",
  "name": "홍길동"
}

### Response (201 Created)
{
  "id": "usr_abc123",
  "email": "user@example.com",
  "name": "홍길동",
  "createdAt": "2024-01-15T10:30:00Z"
}

### Error Responses
| Status | Code | Description |
|--------|------|-------------|
| 400 | VALIDATION_ERROR | 이메일 형식 오류 |
| 409 | DUPLICATE_EMAIL | 이메일 중복 |

---

### 업데이트 요약
- 새로 추가: 3개 엔드포인트
- 업데이트: 2개 엔드포인트
- 예시 코드: 5개 추가 (cURL, JavaScript, Python)

### 검토 필요 항목
- [ ] 인증 섹션 내용 확인 필요
- [ ] 에러 코드 목록 검증 필요`}
  language="markdown"
  filename="Documentation 출력 예시"
/>

---

## 서브에이전트 활용 패턴

### 서브에이전트 오케스트레이션

<MermaidDiagram
  chart={`sequenceDiagram
    participant D as Developer
    participant A as Architect
    participant S as Security
    participant T as Test
    participant DOC as Docs
    D->>A: 설계 검토 요청
    A-->>D: ADR, 설계안
    Note over D: 설계 승인 후 병렬 실행
    par 병렬 실행
      D->>S: 보안 분석
      S-->>D: 취약점 리포트
    and
      D->>T: 테스트 전략
      T-->>D: 테스트 코드
    and
      D->>DOC: 문서 초안
      DOC-->>D: API 문서
    end
    Note over D: 종합 검토 후 구현`}
  title="서브에이전트 오케스트레이션 패턴"
  caption="Architect의 설계 검토 후, Security/Test/Documentation이 병렬로 실행됩니다"
/>

### 격리된 컨텍스트

<Callout type="warning" title="중요">
  각 서브에이전트는 **격리된 컨텍스트**에서 작동합니다.
  하나의 서브에이전트가 다른 서브에이전트의 작업 결과를 직접 참조하지 않으며,
  개발자가 결과를 종합하여 최종 판단합니다.
</Callout>

### 실전 활용 시나리오

<CodeBlock
  code={`# 시나리오: 새 API 엔드포인트 추가

## 1단계: Architect에게 설계 검토
"주문 취소 API를 추가해야 합니다. 현재 주문 시스템 아키텍처를 분석하고
엔드포인트 설계를 제안해주세요."
→ 산출물: API 설계안, 레이어별 변경 목록

## 2단계: 구현 후 병렬 검토
### Security 에이전트
"주문 취소 API 구현 코드를 보안 관점에서 검토해주세요."
→ 산출물: 취약점 리포트 (권한 검증, 입력 검증 등)

### Test 에이전트
"주문 취소 기능의 테스트 전략을 수립하고 테스트 코드를 생성해주세요."
→ 산출물: 단위/통합 테스트 코드

### Documentation 에이전트
"주문 취소 API의 문서를 생성해주세요."
→ 산출물: API 문서 (Request/Response, 에러 코드)

## 3단계: 개발자가 결과 종합
- Security 리포트의 필수 수정 사항 반영
- 테스트 코드 추가 및 실행
- API 문서 검토 후 커밋`}
  language="markdown"
  filename="실전 활용 시나리오"
/>

<Callout type="tip" title="서브에이전트 권한 제어">
  엔터프라이즈 환경에서는 Managed Settings의 deny 규칙으로 특정 서브에이전트를 차단할 수 있습니다.
  예: `"deny": ["Task(Explore)", "Task(Plan)"]`
</Callout>

<ChapterNav
  prev={{ title: '스킬', path: '/docs/part-3--ai-agent-워크플로우-스킬' }}
  next={{ title: 'Hooks', path: '/docs/part-3--ai-agent-워크플로우-hooks' }}
/>
