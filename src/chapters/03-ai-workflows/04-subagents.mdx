import { Meta } from '@storybook/addon-docs/blocks';
import { Callout } from '../../components/Callout';
import { CodeBlock } from '../../components/CodeBlock';
import { ComparisonTable } from '../../components/ComparisonTable';
import { MermaidDiagram } from '../../components/MermaidDiagram';
import { ChapterNav } from '../../components/ChapterNav';

<Meta title="Part 3: AI Agent 워크플로우/서브에이전트" />

# 서브에이전트 (Subagents)

> 전문 분야별 AI 에이전트 시스템

## 개요

서브에이전트는 **전문 분야별 AI 에이전트**입니다. Claude Code는 내부적으로 Task 도구를 통해 서브에이전트를 생성하며, 각 서브에이전트는 독립된 컨텍스트에서 작업을 수행합니다. `.claude/agents/` 디렉토리에 YAML 프론트매터가 포함된 마크다운 파일로 역할별 정의를 저장하여 일관된 전문성을 유지합니다. `/agents` 커맨드로 관리하거나 직접 파일을 생성할 수 있습니다. Anthropic은 대화 초반에 서브에이전트를 적극 활용하여 컨텍스트를 보존하면서 세부 작업을 병렬 처리할 것을 권장합니다.

<Callout type="info" title="핵심 개념">
  서브에이전트는 "한 명의 전문가"와 같습니다.
  아키텍트, 보안 전문가, 테스터, 테크니컬 라이터 — 각각의 전문성을 가진 AI 에이전트가 협력합니다.
</Callout>

## Claude Code 빌트인 서브에이전트

Claude Code는 내부적으로 6개의 빌트인 서브에이전트를 제공합니다. 이들은 Task 도구를 통해 자동으로 선택·실행됩니다.

| 서브에이전트 | 역할 | 사용 가능 도구 |
|-------------|------|---------------|
| **Explore** | 코드베이스 탐색, 파일/키워드 검색 | Read, Glob, Grep 등 (편집 불가) |
| **Plan** | 구현 전략 설계, 아키텍처 분석 | Read, Glob, Grep 등 (편집 불가) |
| **general-purpose** | 복잡한 멀티스텝 작업 수행 | 모든 도구 |
| **Bash** | 셸 명령 실행 전문 | Bash |
| **statusline-setup** | 상태줄 설정 | Read, Edit |
| **Claude Code Guide** | Claude Code 사용법 안내 | Read, Glob, Grep, WebFetch, WebSearch |

<Callout type="tip" title="빌트인 vs 커스텀">
  빌트인 서브에이전트는 Claude Code가 상황에 맞게 자동 선택합니다.
  커스텀 서브에이전트는 `.claude/agents/` 디렉토리에 정의하여 프로젝트 특화 전문성을 추가합니다.
</Callout>

---

## 커스텀 서브에이전트 — 이 프로젝트 템플릿 정의 (4개)

이 프로젝트 템플릿에서 정의한 4개의 커스텀 서브에이전트입니다. `.claude/agents/` 디렉토리에 마크다운 파일로 작성합니다.

<ComparisonTable
  title="커스텀 서브에이전트 비교"
  headers={['항목', 'Architect', 'Security', 'Test', 'Documentation']}
  rows={[
    { feature: '전문 분야', values: ['시스템 설계', '보안 분석', '테스트 전략', '기술 문서'] },
    { feature: '주요 산출물', values: ['ADR, 설계안', '취약점 리포트', '테스트 코드', 'API 문서'] },
    { feature: '참조 지식', values: ['아키텍처 패턴', 'OWASP Top 10', '테스트 피라미드', '문서 표준'] },
    { feature: '활용 시점', values: ['설계/기술 결정', '보안 검토', '테스트 작성', '문서화'] },
  ]}
/>

### 에이전트 정의 파일 구조

<CodeBlock
  code={`---
name: agent-name           # 에이전트 식별자
description: 역할 설명      # Claude가 자동 매칭에 사용
tools: Read, Glob, Grep    # 사용 가능한 도구 목록
model: sonnet              # 사용할 모델 (sonnet, opus 등)
---

# 시스템 프롬프트
에이전트의 역할, 전문성, 작업 절차를 마크다운으로 정의합니다.
이 내용이 서브에이전트의 시스템 프롬프트로 사용됩니다.`}
  language="markdown"
  filename=".claude/agents/ 파일 구조"
/>

---

## Architect 서브에이전트

시스템 설계 및 기술 의사결정을 전문으로 합니다. 아키텍처 검토, ADR 작성, 기술 스택 평가를 수행합니다.

### 에이전트 정의

<CodeBlock
  code={`---
name: architect
description: Analyzes system architecture and makes technical decisions
tools: Read, Glob, Grep, Bash
model: sonnet
---

You are a senior software architect. Your responsibilities:
1. Analyze current system architecture and identify improvement areas
2. Evaluate technology choices with structured comparison matrices
3. Write Architecture Decision Records (ADRs)
4. Ensure architectural principles (SOLID, DDD, Clean Architecture) are followed

Always provide:
- Component dependency analysis
- SWOT analysis for architectural decisions
- Weighted comparison matrices for technology selections`}
  language="markdown"
  filename=".claude/agents/architect.md"
/>

### 분석 프레임워크

<CodeBlock
  code={`## 아키텍처 분석 출력 예시

### 컴포넌트 맵
- 현재 시스템 구성 분석
- 의존성 그래프 작성
- 병목 지점 식별

### SWOT 분석
- Strengths: 현재 아키텍처의 강점
- Weaknesses: 개선이 필요한 부분
- Opportunities: 활용 가능한 기술/패턴
- Threats: 잠재적 위험 요소

### 기술 선정 매트릭스
| 기준 | 가중치 | 옵션 A | 옵션 B |
|------|--------|--------|--------|
| 성능 | 30% | 8/10 | 7/10 |
| 확장성 | 25% | 9/10 | 6/10 |
| 학습 곡선 | 20% | 5/10 | 8/10 |
| 커뮤니티 | 15% | 7/10 | 9/10 |
| 비용 | 10% | 6/10 | 8/10 |

### 결정
가중 점수 기반 옵션 A 선택 (7.35 vs 7.15)`}
  language="markdown"
  filename="Architect 분석 출력 예시"
/>

---

## Security 서브에이전트

보안 코드 리뷰와 취약점 분석을 전문으로 합니다. OWASP Top 10 기반 분석, 공격 시나리오 시뮬레이션, 수정 코드 제안을 수행합니다.

### 에이전트 정의

<CodeBlock
  code={`---
name: security-reviewer
description: Reviews code for security vulnerabilities
tools: Read, Glob, Grep, Bash
model: sonnet
---

You are a security expert specializing in application security.
Analyze code for OWASP Top 10 vulnerabilities with focus on:
1. Injection attacks (SQL, NoSQL, OS command, LDAP)
2. Broken authentication and session management
3. Cross-Site Scripting (XSS)
4. Insecure Direct Object References (IDOR)
5. Security misconfigurations
6. Sensitive data exposure

For each vulnerability found, provide:
- Severity (Critical/High/Medium/Low)
- Exact file and line location
- Attack scenario demonstrating the risk
- Remediation code with explanation
- CWE/OWASP reference`}
  language="markdown"
  filename=".claude/agents/security-reviewer.md"
/>

### 취약점 리포트 출력 형식

<CodeBlock
  code={`## 보안 분석 리포트

### 취약점 #1: IDOR (Insecure Direct Object Reference)
- 심각도: 🔴 Critical
- 위치: src/api/users.ts:45
- 유형: OWASP A01:2025 — Broken Access Control

### 현재 코드 (취약)
@Get(':id')
async getUser(@Param('id') id: string) {
  return this.userService.findById(id); // 권한 확인 없음
}

### 공격 시나리오
curl -H "Authorization: Bearer <attacker_token>" \\
     https://api.example.com/users/victim-user-id

### 수정 코드
@Get(':id')
@UseGuards(AuthGuard)
async getUser(@Param('id') id: string, @CurrentUser() user: User) {
  if (id !== user.id && !user.isAdmin) {
    throw new ForbiddenException();
  }
  return this.userService.findById(id);
}

### 참고: CWE-639, OWASP A01:2025`}
  language="typescript"
  filename="Security 리포트 출력 예시"
/>

---

## Test 서브에이전트

테스트 전략 수립과 테스트 코드 생성을 전문으로 합니다. 단위/통합/E2E 테스트 코드, 커버리지 분석, 테스트 리뷰를 수행합니다.

### 에이전트 정의

<CodeBlock
  code={`---
name: test-strategist
description: Creates test strategies and generates test code
tools: Read, Glob, Grep, Bash
model: sonnet
---

You are a test engineering expert. Your responsibilities:
1. Analyze code and determine optimal test strategy
2. Follow the test pyramid: Unit (70%) > Integration (20%) > E2E (10%)
3. Apply FIRST principles (Fast, Independent, Repeatable, Self-validating, Timely)
4. Use AAA pattern (Arrange-Act-Assert) for all tests
5. Generate comprehensive test cases including edge cases

For each test file, provide:
- Test case list with descriptions
- Complete test code with mocks and fixtures
- Expected coverage metrics per layer
- Factory patterns for test data`}
  language="markdown"
  filename=".claude/agents/test.md"
/>

### 테스트 전략 출력 예시

<CodeBlock
  code={`## 테스트 전략: UserService

### 테스트 케이스 목록
| # | 유형 | 케이스 | 예상 결과 |
|---|------|--------|----------|
| 1 | Unit | 유효한 데이터로 사용자 생성 | 사용자 객체 반환 |
| 2 | Unit | 잘못된 이메일로 생성 시도 | ValidationError |
| 3 | Unit | 중복 이메일로 생성 시도 | DuplicateError |
| 4 | Unit | 존재하지 않는 사용자 조회 | null 반환 |
| 5 | Integration | POST /api/users 201 응답 | 생성된 사용자 JSON |
| 6 | Integration | POST /api/users 409 중복 | 에러 메시지 |

### 테스트 코드 (발췌)
describe('UserService', () => {
  const mockRepo: jest.Mocked<IUserRepository> = {
    findByEmail: jest.fn(),
    save: jest.fn(),
  };

  it('should create user with valid data', async () => {
    mockRepo.findByEmail.mockResolvedValue(null);
    mockRepo.save.mockResolvedValue({ id: '1', email: 'test@test.com' });

    const result = await service.createUser({ email: 'test@test.com' });
    expect(result.id).toBe('1');
    expect(mockRepo.save).toHaveBeenCalledTimes(1);
  });
});

### 커버리지 예상
- Lines: ~85%  |  Branches: ~80%  |  Functions: ~90%`}
  language="typescript"
  filename="Test 전략 출력 예시"
/>

---

## Documentation 서브에이전트

기술 문서 작성을 전문으로 합니다. API 문서(REST, GraphQL), 코드 문서(JSDoc, Docstring), README, 코드-문서 동기화 검증을 수행합니다.

### 에이전트 정의

<CodeBlock
  code={`---
name: documentation
description: Generates and maintains technical documentation
tools: Read, Glob, Grep, Bash
model: sonnet
---

You are a technical writer specializing in developer documentation.
Your responsibilities:
1. Generate API documentation (REST endpoints with Request/Response schemas)
2. Create code documentation (JSDoc for TypeScript, Docstrings for Python)
3. Structure README files with badges, quick start, and architecture overview
4. Write Architecture Decision Records (ADRs)
5. Verify code-documentation synchronization

Documentation quality standards:
- Accuracy: Must match current code behavior
- Completeness: All public APIs documented with examples
- Clarity: Written for developers unfamiliar with the codebase
- Searchability: Consistent headings and structure`}
  language="markdown"
  filename=".claude/agents/documentation.md"
/>

### 문서 생성 출력 예시

<CodeBlock
  code={`## 생성된 문서

### 파일: docs/api/users.md

## POST /api/v1/users — 사용자 생성

### Request
Content-Type: application/json
Authorization: Bearer <token>

{
  "email": "user@example.com",
  "name": "홍길동"
}

### Response (201 Created)
{
  "id": "usr_abc123",
  "email": "user@example.com",
  "name": "홍길동",
  "createdAt": "2024-01-15T10:30:00Z"
}

### Error Responses
| Status | Code | Description |
|--------|------|-------------|
| 400 | VALIDATION_ERROR | 이메일 형식 오류 |
| 409 | DUPLICATE_EMAIL | 이메일 중복 |

---

### 업데이트 요약
- 새로 추가: 3개 엔드포인트
- 업데이트: 2개 엔드포인트
- 예시 코드: 5개 추가 (cURL, JavaScript, Python)

### 검토 필요 항목
- [ ] 인증 섹션 내용 확인 필요
- [ ] 에러 코드 목록 검증 필요`}
  language="markdown"
  filename="Documentation 출력 예시"
/>

---

## 서브에이전트 활용 패턴

### 서브에이전트 오케스트레이션

<MermaidDiagram
  chart={`sequenceDiagram
    participant D as Developer
    participant A as Architect
    participant S as Security
    participant T as Test
    participant DOC as Docs
    D->>A: 설계 검토 요청
    A-->>D: ADR, 설계안
    Note over D: 설계 승인 후 병렬 실행
    par 병렬 실행
      D->>S: 보안 분석
      S-->>D: 취약점 리포트
    and
      D->>T: 테스트 전략
      T-->>D: 테스트 코드
    and
      D->>DOC: 문서 초안
      DOC-->>D: API 문서
    end
    Note over D: 종합 검토 후 구현`}
  title="서브에이전트 오케스트레이션 패턴"
  caption="Architect의 설계 검토 후, Security/Test/Documentation이 병렬로 실행됩니다"
/>

### 격리된 컨텍스트

<Callout type="warning" title="중요">
  각 서브에이전트는 **격리된 컨텍스트**에서 작동합니다.
  하나의 서브에이전트가 다른 서브에이전트의 작업 결과를 직접 참조하지 않으며,
  개발자가 결과를 종합하여 최종 판단합니다.
</Callout>

### 실전 활용 시나리오

<CodeBlock
  code={`# 시나리오: 새 API 엔드포인트 추가

## 1단계: Architect에게 설계 검토
"주문 취소 API를 추가해야 합니다. 현재 주문 시스템 아키텍처를 분석하고
엔드포인트 설계를 제안해주세요."
→ 산출물: API 설계안, 레이어별 변경 목록

## 2단계: 구현 후 병렬 검토
### Security 에이전트
"주문 취소 API 구현 코드를 보안 관점에서 검토해주세요."
→ 산출물: 취약점 리포트 (권한 검증, 입력 검증 등)

### Test 에이전트
"주문 취소 기능의 테스트 전략을 수립하고 테스트 코드를 생성해주세요."
→ 산출물: 단위/통합 테스트 코드

### Documentation 에이전트
"주문 취소 API의 문서를 생성해주세요."
→ 산출물: API 문서 (Request/Response, 에러 코드)

## 3단계: 개발자가 결과 종합
- Security 리포트의 필수 수정 사항 반영
- 테스트 코드 추가 및 실행
- API 문서 검토 후 커밋`}
  language="markdown"
  filename="실전 활용 시나리오"
/>

<Callout type="tip" title="서브에이전트 권한 제어">
  엔터프라이즈 환경에서는 Managed Settings의 deny 규칙으로 특정 서브에이전트를 차단할 수 있습니다.
  예: `"deny": ["Task(Explore)", "Task(Plan)"]`
</Callout>

---

## Agent Teams — 멀티 에이전트 협업 (2026년 2월~)

2026년 2월 Claude Opus 4.6과 함께 출시된 **Agent Teams**는 서브에이전트의 진화형입니다. 기존 서브에이전트가 "메인 에이전트 → 서브에이전트"의 일방향 위임이었다면, Agent Teams는 **여러 Claude 인스턴스가 팀으로 직접 협력**하는 네이티브 멀티 에이전트 시스템입니다.

<Callout type="info" title="서브에이전트 vs Agent Teams">
  **서브에이전트**: 메인 세션이 Task 도구로 서브태스크 위임. 결과만 돌아옴. 서브에이전트끼리 통신 불가.
  **Agent Teams**: 팀 리더가 작업 조율. 팀원들이 독립적으로 작업하며 **서로 직접 통신**. 공유 코드베이스에서 병렬 작업.
</Callout>

### 아키텍처

<MermaidDiagram
  chart={`flowchart TB
    TL["Team Lead\n(작업 조율 & 할당)"]
    T1["Teammate 1\n(프론트엔드)"]
    T2["Teammate 2\n(백엔드)"]
    T3["Teammate 3\n(테스트)"]
    T4["Teammate 4\n(문서)"]
    TL --> T1
    TL --> T2
    TL --> T3
    TL --> T4
    T1 <--> T2
    T2 <--> T3
    T3 <--> T4
    style TL fill:#fdf2ee,stroke:#da7756,color:#2d2a26
    style T1 fill:#f0f4ff,stroke:#5B8DEF,color:#2d2a26
    style T2 fill:#f0f4ff,stroke:#5B8DEF,color:#2d2a26
    style T3 fill:#f0f4ff,stroke:#5B8DEF,color:#2d2a26
    style T4 fill:#f0f4ff,stroke:#5B8DEF,color:#2d2a26`}
  title="Agent Teams 아키텍처"
  caption="팀 리더가 작업을 조율하고, 팀원들은 독립 컨텍스트에서 작업하면서 서로 직접 통신합니다"
/>

### 활성화 방법

<CodeBlock
  code={`# 방법 1: 환경 변수
export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1

# 방법 2: settings.json
{
  "CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS": true
}

# 방법 3: Claude Code 실행 시
claude --experimental-agent-teams`}
  language="bash"
  filename="Agent Teams 활성화"
/>

<Callout type="warning" title="Research Preview">
  Agent Teams는 현재 **Research Preview** 단계입니다. 실험적 기능이므로 프로덕션 환경에서는 주의하여 사용하세요.
</Callout>

### 최적 사용 사례

<ComparisonTable
  title="Agent Teams 활용 시나리오"
  headers={['시나리오', '팀 구성 예시', '효과']}
  rows={[
    { feature: '새 모듈 개발', values: ['프론트엔드 + 백엔드 + 테스트 + 문서', '크로스 레이어 병렬 개발'] },
    { feature: '대규모 리팩토링', values: ['분석 + 구현A + 구현B + 검증', '파일별/모듈별 병렬 수정'] },
    { feature: '디버깅 (경쟁 가설)', values: ['가설1 + 가설2 + 가설3 + 가설4', '여러 원인을 동시 조사'] },
    { feature: '코드 리뷰 + 보안 검토', values: ['기능 리뷰 + 보안 리뷰 + 성능 분석', '다각도 병렬 리뷰'] },
  ]}
/>

### Headless Mode와 조합

`claude -p` 플래그를 사용하면 여러 Claude 인스턴스를 스크립트로 병렬 실행할 수 있습니다. Agent Teams의 가벼운 대안으로, CI/CD 파이프라인에서 특히 유용합니다.

<CodeBlock
  code={`# 여러 디렉토리에 대해 병렬로 Claude 실행
claude -p "src/frontend/ 의 모든 deprecated API 호출을 새 API로 마이그레이션해줘" &
claude -p "src/backend/ 의 모든 SQL 쿼리를 parameterized query로 변환해줘" &
claude -p "src/tests/ 의 테스트를 새 API에 맞게 업데이트해줘" &
wait

# CI/CD에서 병렬 코드 리뷰
git diff main | claude -p "이 변경사항을 보안 관점에서 리뷰해줘" &
git diff main | claude -p "이 변경사항을 성능 관점에서 리뷰해줘" &
wait`}
  language="bash"
  filename="Headless Mode 병렬 실행"
/>

---

## 실증 사례: C 컴파일러 구축

Anthropic 엔지니어링 블로그에서 공개한 **Agent Teams의 가장 인상적인 사례**입니다.

### 프로젝트 개요

| 항목 | 내용 |
|------|------|
| **목표** | Linux 커널을 컴파일할 수 있는 Rust 기반 C 컴파일러를 처음부터 구축 |
| **에이전트 수** | 16개 Claude Opus 4.6 인스턴스 |
| **세션 수** | 약 2,000회 Claude Code 세션 |
| **비용** | $20,000 API 비용 |
| **결과물** | 100,000줄의 컴파일러 코드 |
| **성과** | x86, ARM, RISC-V에서 Linux 6.9 컴파일 성공 |
| **테스트** | GCC torture test suite **99%** 통과 |
| **추가 검증** | 클래식 게임 Doom 컴파일 및 실행 성공 |

<Callout type="info" title="출처">
  Nicholas Carlini(Anthropic Safeguards 팀)의 공식 엔지니어링 블로그 포스트:
  [Building a C compiler with a team of parallel Claudes](https://www.anthropic.com/engineering/building-c-compiler)
</Callout>

### 작업 방식

16개의 에이전트가 공유 코드베이스에서 다음과 같이 역할을 분담했습니다:

1. **파서 에이전트**: C 언어 구문 분석기 구현
2. **코드 생성 에이전트**: x86/ARM/RISC-V 백엔드 구현
3. **최적화 에이전트**: 코드 최적화 패스 구현
4. **테스트 에이전트**: GCC torture test suite 기반 검증
5. **통합 에이전트**: 각 모듈의 인터페이스 조율

사람의 개입 없이 에이전트들이 자율적으로 개발을 진행했으며, Anthropic도 이렇게 빨리 가능할 것이라고 예상하지 못했다고 밝혔습니다.

---

## Claude Agent SDK

Agent Teams를 프로그래밍 방식으로 구축하려면 **Claude Agent SDK**를 사용합니다.

<CodeBlock
  code={`# Python SDK 설치
pip install claude-agent-sdk

# TypeScript SDK 설치
npm install @anthropic-ai/claude-agent-sdk`}
  language="bash"
  filename="Claude Agent SDK 설치"
/>

<CodeBlock
  code={`# Python 예시: 에이전트 생성 및 실행
from claude_agent_sdk import Agent

# 에이전트 정의 — 도구 구현 없이 작업만 정의하면
# SDK가 파일 읽기, 명령 실행, 코드 편집 등을 자동 처리
agent = Agent(
    model="claude-opus-4-6",
    task="src/api/ 디렉토리의 모든 엔드포인트에 rate limiting을 추가해줘",
    tools=["read", "edit", "bash"],  # 내장 도구 사용
)

result = agent.run()
print(result.summary)`}
  language="python"
  filename="Claude Agent SDK 사용 예시"
/>

<Callout type="tip" title="Agent SDK 공식 문서">
  - Python SDK: [github.com/anthropics/claude-agent-sdk-python](https://github.com/anthropics/claude-agent-sdk-python)
  - TypeScript SDK: [npmjs.com/package/@anthropic-ai/claude-agent-sdk](https://www.npmjs.com/package/@anthropic-ai/claude-agent-sdk)
  - 공식 가이드: [Building agents with the Claude Agent SDK](https://www.anthropic.com/engineering/building-agents-with-the-claude-agent-sdk)
</Callout>

<ChapterNav
  prev={{ title: '스킬', path: '/docs/part-3--ai-agent-워크플로우-스킬' }}
  next={{ title: 'Hooks', path: '/docs/part-3--ai-agent-워크플로우-hooks' }}
/>
