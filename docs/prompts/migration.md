# Migration Prompt

## 목적
코드, 데이터, 또는 시스템을 안전하게 마이그레이션합니다.

## 컨텍스트
현재 상태와 목표 상태, 제약 조건을 명확히 정의해야 합니다.

---

## 프롬프트 템플릿

```
마이그레이션을 도와줘.

### 마이그레이션 유형
[코드 마이그레이션 / 데이터 마이그레이션 / 의존성 업그레이드 / 플랫폼 전환]

### 현재 상태
- [현재 버전/기술/상태]
- [현재 구조 설명]

### 목표 상태
- [목표 버전/기술/상태]
- [목표 구조 설명]

### 제약 조건
- [다운타임 허용 여부]
- [데이터 손실 허용 여부]
- [롤백 요구사항]
- [호환성 요구사항]

### 영향 범위
- [영향받는 서비스/컴포넌트]
- [영향받는 사용자/팀]

다음을 제공해줘:
1. 마이그레이션 계획
2. 단계별 실행 가이드
3. 롤백 계획
4. 검증 체크리스트
```

---

## 출력 형식

```markdown
## 마이그레이션 계획

### 개요
[마이그레이션의 목적과 범위 요약]

### 위험 평가
| 위험 | 영향도 | 발생확률 | 대응방안 |
|------|--------|----------|----------|
| ... | High/Med/Low | High/Med/Low | ... |

### 선행 작업
1. [백업]
2. [테스트 환경 준비]
3. [롤백 스크립트 준비]

### 실행 단계

#### Phase 1: 준비
- [ ] 작업 1
- [ ] 작업 2

#### Phase 2: 마이그레이션 실행
- [ ] 작업 1
- [ ] 작업 2

#### Phase 3: 검증
- [ ] 검증 항목 1
- [ ] 검증 항목 2

### 롤백 계획
[문제 발생 시 원복 절차]

### 검증 체크리스트
- [ ] 기능 테스트
- [ ] 성능 테스트
- [ ] 데이터 정합성
```

---

## 예시

### 입력
```
마이그레이션을 도와줘.

### 마이그레이션 유형
데이터베이스 마이그레이션 (MySQL 5.7 → PostgreSQL 15)

### 현재 상태
- MySQL 5.7
- 테이블 50개, 데이터 약 10GB
- Django ORM 사용

### 목표 상태
- PostgreSQL 15
- 동일한 스키마 구조 유지
- Django ORM 연동

### 제약 조건
- 다운타임 2시간 이내
- 데이터 손실 불가
- 롤백 가능해야 함

### 영향 범위
- 메인 애플리케이션 서버 3대
- 배치 서버 1대
- 리포팅 시스템
```

### 출력
```markdown
## 마이그레이션 계획: MySQL → PostgreSQL

### 개요
MySQL 5.7에서 PostgreSQL 15로 데이터베이스를 마이그레이션합니다.
Django ORM을 사용하므로 스키마 변환은 비교적 단순하나,
MySQL 특화 기능 사용 여부를 확인해야 합니다.

### 위험 평가
| 위험 | 영향도 | 발생확률 | 대응방안 |
|------|--------|----------|----------|
| 데이터 타입 불일치 | High | Medium | 사전 스키마 분석 |
| 성능 저하 | Medium | Medium | 인덱스 최적화 |
| 쿼리 호환성 | Medium | Low | Raw SQL 점검 |
| 다운타임 초과 | High | Low | 증분 마이그레이션 |

### 선행 작업

1. **코드 점검** (1주)
   ```bash
   # MySQL 특화 함수 사용 검색
   grep -r "MySQL\|STRAIGHT_JOIN\|FORCE INDEX" src/
   ```

2. **스키마 변환 테스트**
   ```bash
   pgloader mysql://source postgresql://target
   ```

3. **백업**
   ```bash
   mysqldump --all-databases > full_backup.sql
   ```

### 실행 단계

#### Phase 1: 준비 (D-7)
- [x] PostgreSQL 서버 프로비저닝
- [x] Django settings 분기 준비
- [x] 테스트 데이터로 마이그레이션 리허설

#### Phase 2: 마이그레이션 실행 (D-Day)

```
T-00:00 서비스 점검 모드 전환
T-00:10 MySQL 최종 백업
T-00:30 pgloader로 데이터 마이그레이션
T-01:30 Django 설정 전환
T-01:45 스모크 테스트
T-02:00 서비스 재개
```

#### Phase 3: 검증 (D+1~3)
- [ ] 전체 기능 테스트
- [ ] 쿼리 성능 모니터링
- [ ] 데이터 정합성 검증

### 롤백 계획

**롤백 결정 기준:**
- 마이그레이션 2시간 초과
- 데이터 정합성 오류 발견
- 심각한 성능 저하

**롤백 절차:**
1. Django settings를 MySQL로 원복
2. 서비스 재시작
3. 마이그레이션 중 발생한 데이터 손실 확인

### 검증 체크리스트
- [ ] 레코드 수 일치 (테이블별)
- [ ] 외래 키 정합성
- [ ] 인덱스 생성 확인
- [ ] 주요 쿼리 성능 비교
- [ ] 배치 작업 정상 동작
```

---

## 체크리스트 by 마이그레이션 유형

### 코드 마이그레이션
- [ ] 종속성 확인
- [ ] API 호환성 테스트
- [ ] 기능 테스트

### 데이터 마이그레이션
- [ ] 백업 완료
- [ ] 스키마 호환성
- [ ] 데이터 정합성

### 의존성 업그레이드
- [ ] Breaking changes 확인
- [ ] 종속 라이브러리 호환성
- [ ] 보안 취약점 해소

### 플랫폼 전환
- [ ] 인프라 준비
- [ ] 네트워크 설정
- [ ] 모니터링 설정
